import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

Since RavenDB 4.0, the query optimizer supports dynamic group by queries and automatically creates auto map-reduce indexes.

You can create a dynamic query that does an aggregation by using the LINQ `GroupBy()` method or `group by into` syntax.

The supported aggregation operations are:

- `Count`
- `Sum`


## Group By Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = (from o in session.Query<Order>()
        group o by o.ShipTo.Country
        into g
        select new
        {
            Country = g.Key,
            OrderedQuantity = g.Sum(order => order.Lines.Sum(line => line.Quantity))
        })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await (from o in asyncSession.Query<Order>()
        group o by o.ShipTo.Country
        into g
        select new
        {
            Country = g.Key,
            OrderedQuantity = g.Sum(order => order.Lines.Sum(line => line.Quantity))
        })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => new
    {
        x.Employee,
        x.Company
    })
    .Select(x => new
    {
        EmployeeIdentifier = x.Key.Employee,
        x.Key.Company,
        Count = x.Count()
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => new
    {
        x.Employee,
        x.Company
    })
    .Select(x => new
    {
        EmployeeIdentifier = x.Key.Employee,
        x.Key.Company,
        Count = x.Count()
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => new EmployeeAndCompany
    {
        Employee = x.Employee,
        Company = x.Company
    })
    .Select(x => new CountOfEmployeeAndCompanyPairs
    {
        EmployeeCompanyPair = x.Key,
        Count = x.Count()
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => new EmployeeAndCompany
    {
        Employee = x.Employee,
        Company = x.Company
    })
    .Select(x => new CountOfEmployeeAndCompanyPairs
    {
        EmployeeCompanyPair = x.Key,
        Count = x.Count()
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

In order to group by values of array, you need to use `GroupByArrayValues`. The following query will group by `Product` property from `Lines` collection 
and calculate the count per ordered products. Underneath a fanout, an auto map-reduce index will be created to handle such query. 

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => y.Product))
    .Select(x => new
    {
        Count = x.Count(),
        Product = x.Key
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => y.Product))
    .Select(x => new
    {
        Count = x.Count(),
        Product = x.Key
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Inside a single group by statement you can mix collection values and value of another property. That's supported by `DocumentQuery` only:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy("Lines[].Product", "ShipTo.Country")
    .SelectKey("Lines[].Product", "Product")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy("Lines[].Product", "ShipTo.Country")
    .SelectKey("Lines[].Product", "Product")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is supported as well:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => new
    {
        y.Product,
        y.Quantity
    }))
    .Select(x => new ProductInfo
    {
        Count = x.Count(),
        Product = x.Key.Product,
        Quantity = x.Key.Quantity
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => new
    {
        y.Product,
        y.Quantity
    }))
    .Select(x => new ProductInfo
    {
        Count = x.Count(),
        Product = x.Key.Product,
        Quantity = x.Key.Quantity
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array content. The reduction key will be calculated based on all values of a collection specified in `GroupBy`.
The client API exposes the `GroupByArrayContent` extension method for that purpose.

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayContent(x => x.Lines.Select(y => y.Product))
    .Select(x => new ProductsInfo
    {
        Count = x.Count(),
        Products = x.Key
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayContent(x => x.Lines.Select(y => y.Product))
    .Select(x => new ProductsInfo
    {
        Count = x.Count(),
        Products = x.Key
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by array content and a value of another property is supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("ShipTo.Country", GroupByMethod.None))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("ShipTo.Country", GroupByMethod.None))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is also supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("Lines[].Quantity", GroupByMethod.Array))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("Lines[].Quantity", "Quantities")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("Lines[].Quantity", GroupByMethod.Array))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("Lines[].Quantity", "Quantities")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

<Admonition type="note" title="Note" id="note" href="#note">
In order to use the above extension methods you need to add the following **using** statement:

<TabItem value="group_by_using" label="group_by_using">
<CodeBlock language="csharp">
{`using Raven.Client.Documents;
`}
</CodeBlock>
</TabItem>
</Admonition>



## Sorting

Results of dynamic group by queries can be sorted by an aggregation function used in the query. As the available aggregation operations are `Count` and `Sum` you can use them to
order the results.

#### By Count

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by count() as long 
select Employee, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

#### By Sum

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Sum = x.Sum(y => y.Freight)
    })
    .OrderBy(x => x.Sum)
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by sum(Freight) as double 
select key() as Employee, sum(Freight) as Sum
`}
</CodeBlock>
</TabItem>
</Tabs>




