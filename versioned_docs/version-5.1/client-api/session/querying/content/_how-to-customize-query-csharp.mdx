import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

The following query customization options are available in the `IDocumentQueryCustomization` interface:

- [BeforeQueryExecuted](../../../../client-api/session/querying/how-to-customize-query.mdx#beforequeryexecuted)
- [AfterQueryExecuted](../../../../client-api/session/querying/how-to-customize-query.mdx#afterqueryexecuted)
- [AfterStreamExecuted](../../../../client-api/session/querying/how-to-customize-query.mdx#afterstreamexecuted)
- [NoCaching](../../../../client-api/session/querying/how-to-customize-query.mdx#nocaching)
- [NoTracking](../../../../client-api/session/querying/how-to-customize-query.mdx#notracking)
- [ProjectionBehavior](../../../../client-api/session/querying/how-to-customize-query.mdx#projectionbehavior)
- [RandomOrdering](../../../../client-api/session/querying/how-to-customize-query.mdx#randomordering)
- [WaitForNonStaleResults](../../../../client-api/session/querying/how-to-customize-query.mdx#waitfornonstaleresults)

</Admonition>
## BeforeQueryExecuted

Allows you to modify the index query just before it's executed.

<TabItem value="customize_1_0" label="customize_1_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization BeforeQueryExecuted(Action<IndexQuery> action);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **action** | Action&lt;[IndexQuery](../../../../glossary/index-query.mdx)&gt; | Action that will modify IndexQuery. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_1_1" label="customize_1_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'BeforeQueryExecuted'
    .Customize(x => x.BeforeQueryExecuted(query =>
    \{
        // Can modify query parameters
        query.SkipDuplicateChecking = true;
        // Can apply any needed action, e.g. write to log
        _logger.Info($"Query to be executed is: \{query.Query\}");
    \}))
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## AfterQueryExecuted

Allows you to retrieve a raw query result after it's executed.

<TabItem value="customize_1_0_0" label="customize_1_0_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization AfterQueryExecuted(Action<QueryResult> action);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **action** | Action&lt;[QueryResult](../../../../glossary/query-result.mdx)&gt; | Action that has the query result. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_1_1_0" label="customize_1_1_0">
<CodeBlock language="csharp">
{`TimeSpan queryDuration;

List<Employee> results = session.Query<Employee>()
    .Customize(x => x.AfterQueryExecuted(
        result => queryDuration = TimeSpan.FromMilliseconds(result.DurationInMs)))
    .ToList();
`}
</CodeBlock>
</TabItem>



## AfterStreamExecuted

Allows you to retrieve a raw (blittable) result of the streaming query.

<TabItem value="customize_1_0_1" label="customize_1_0_1">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization AfterStreamExecuted(Action<BlittableJsonReaderObject> action);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **action** | Action&lt;[BlittableJsonReaderObject](../../../../glossary/blittable-json-reader-object.mdx)&gt; | Action that has the single query result. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_1_1_1" label="customize_1_1_1">
<CodeBlock language="csharp">
{`long totalStreamedResultsSize = 0;

List<Employee> results = session.Query<Employee>()
    .Customize(x => x.AfterStreamExecuted(
        result => totalStreamedResultsSize += result.Size))
    .ToList();
`}
</CodeBlock>
</TabItem>



## NoCaching

By default, queries are cached. To disable query caching use the `NoCaching` customization.

<TabItem value="customize_2_0" label="customize_2_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization NoCaching();
`}
</CodeBlock>
</TabItem>

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_2_1" label="customize_2_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'AfterQueryExecuted'
    .Customize(x => x.AfterQueryExecuted(rawResult =>
    \{
        // Can access the raw query result
        var queryDuration = rawResult.DurationInMs;
        // Can apply any needed action, e.g. write to log
        _logger.Info($"\{rawResult.LastQueryTime\}");
    \}))
    .ToList();
`}
</CodeBlock>
</TabItem>



## NoTracking

To disable entity tracking by `Session` use `NoTracking`. Usage of this option will prevent holding the query results in memory.

<TabItem value="customize_3_0" label="customize_3_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization NoTracking();
`}
</CodeBlock>
</TabItem>

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_3_1" label="customize_3_1">
<CodeBlock language="csharp">
{`long totalStreamedResultsSize = 0;

// Define the query
var query = session
    .Query<Employee>()
     // Call 'Customize' with 'AfterStreamExecuted'
    .Customize(x => x.AfterStreamExecuted(streamResult =>
        // Can access the stream result
        totalStreamedResultsSize += streamResult.Size));
    
// Call 'Stream' to execute the query
var streamResults = session.Advanced.Stream(query);
`}
</CodeBlock>
</TabItem>



## ProjectionBehavior

By default, queries are satisfied with the values stored in the index. If the index 
doesn't contain the requested values, they are retrieved from the documents 
themselves.  

This behavior can be configured using the `Projection` option, which takes a 
`ProjectionBehavior`:  

<TabItem value="projectionbehavior" label="projectionbehavior">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization Projection(ProjectionBehavior projectionBehavior);

public enum ProjectionBehavior \{
    Default,
    FromIndex,
    FromIndexOrThrow,
    FromDocument,
    FromDocumentOrThrow
\}
`}
</CodeBlock>
</TabItem>

* `Default` - query will be satisfied with indexed data when possible, and directly 
from the document when it is not.  
* `FromIndex` - query will be satisfied with indexed data when possible, and when 
it is not, the field is skipped.  
* `FromIndexOrThrow` - query will be satisfied with indexed data. If the index does 
not contain the requested data, an exception is thrown.  
* `FromDocument` - query will be satisfied with document data when possible, and 
when it is not, the field is skipped.  
* `FromDocumentOrThrow` - query will be satisfied with document data. If the 
document does not contain the requested data, an exception is thrown.  

### Example

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="csharp">
{`List<Employee> results = session.Query<Employee>()
    .Customize(x => x.Projection(ProjectionBehavior.FromDocument))
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
<CodeBlock language="csharp">
{`List<Employee> results = session.Advanced.RawQuery<Employee>(
    @"from Employees")
    .Projection(ProjectionBehavior.FromDocument)
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="DocumentQuery" label="DocumentQuery">
<CodeBlock language="csharp">
{`List<Employee> results = session.Advanced.DocumentQuery<Employee>()
    .SelectFields<Employee>(ProjectionBehavior.FromDocument)
    .ToList();
`}
</CodeBlock>
</TabItem>
</Tabs>



## RandomOrdering

To order results randomly, use the `RandomOrdering` method.

<TabItem value="customize_4_0" label="customize_4_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization RandomOrdering();

IDocumentQueryCustomization RandomOrdering(string seed);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **seed** | string | Seed used for ordering. Useful when repeatable random queries are needed. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_4_1" label="customize_4_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'NoCaching'
    .Customize(x => x.NoCaching())
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## WaitForNonStaleResults

Queries can be 'instructed' to wait for non-stale results for a specified amount of time using the `WaitForNonStaleResults` method. If the query won't be able to return 
non-stale results within the specified (or default) timeout, then a `TimeoutException` is thrown.

<Admonition type="note" title="Cutoff Point" id="cutoff-point" href="#cutoff-point">
If a query sent to the server specifies that it needs to wait for non-stale results, then RavenDB sets the cutoff Etag for the staleness check.
It is the Etag of the last document (or document tombstone), from the collection(s) processed by the index, as of the query arrived to the server.
This way the server won't be waiting forever for the non-stale results even though documents are constantly updated meanwhile.

If the last Etag processed by the index is greater than the cutoff then the results are considered as non-stale.
</Admonition>


<TabItem value="customize_8_0" label="customize_8_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization WaitForNonStaleResults(TimeSpan? waitTimeout);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **waitTimeout** | TimeSpan? | Time to wait for an index to return non-stale results. The default is 15 seconds. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_8_1" label="customize_8_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'WaitForNonStaleResults'
    .Customize(x => x.WaitForNonStaleResults(TimeSpan.FromSeconds(10)))
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>




