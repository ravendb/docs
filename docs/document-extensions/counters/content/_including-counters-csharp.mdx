import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import ContentFrame from '@site/src/components/ContentFrame';
import Panel from '@site/src/components/Panel';

<Admonition type="note" title="">

* Counters can be included when [loading entities](../../client-api/session/loading-entities) 
  or when making [queries](../../../querying/overview.mdx).
 
* The _Session_ stores the included counters in its in-memory cache,  
  so their values can be accessed later in the same session without making additional requests to the server.
    
* To see how to include counters when creating a subscription, see
  [Create subscription - include counters](../../../client-api/data-subscriptions/creation/examples.mdx#create-subscription---include-counters).

* In this article:
    * [Sample data](../../../document-extensions/counters/including-counters.mdx#sample-data)
    * [Include counters when **loading**](../../../document-extensions/counters/including-counters.mdx#include-counters-when-loading)
      * [Include single counter](../../../document-extensions/counters/including-counters.mdx#include-single-counter)
      * [Include multiple counters](../../../document-extensions/counters/including-counters.mdx#include-multiple-counters)
      * [Include all counters](../../../document-extensions/counters/including-counters.mdx#include-all-counters)
    * [Include counters when **querying**](../../../document-extensions/counters/including-counters.mdx#include-counters-when-querying)
      * [Include single counter](../../../document-extensions/counters/including-counters.mdx#include-single-counter-1)
      * [Include multiple counters](../../../document-extensions/counters/including-counters.mdx#include-multiple-counters-1)
      * [Include all counters](../../../document-extensions/counters/including-counters.mdx#include-all-counters-1)
    * [Including multiple item types](../../../document-extensions/counters/including-counters.mdx#including-multiple-item-types)
    * [Include behavior and constraints](../../../document-extensions/counters/including-counters.mdx#include-behavior-and-constraints)
    * [Syntax](../../../document-extensions/counters/including-counters.mdx#syntax)

</Admonition>

<Panel heading="Sample data">

The examples in this article are based on the following **sample data**:  

<Tabs groupId='languageSyntax'>
<TabItem value="Sample_counters" label="Sample_counters">
```csharp
using (var session = store.OpenSession())
{  
    var documentCounters = session.CountersFor("products/1-A");
    
    // Increase counter "Likes" by 1, or create it with a value of 1 if it doesn't exist
    documentCounters.Increment("Likes");    
    // Increase counter "Dislikes" by 1, or create it with a value of 1 if it doesn't exist
    documentCounters.Increment("Dislikes", 1);
    // Increase counter "Downloads" by 15, or create it with a value of 15 if it doesn't exist
    documentCounters.Increment("Downloads", 15);

    session.SaveChanges();
}
```
</TabItem>
<TabItem value="Product_class" label="Product_class">
```csharp
public class Product
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Supplier { get; set; }
    public string Descripton { get; set; }
}
```
</TabItem>
</Tabs>
    
</Panel>

<Panel heading="Include counters when loading">

<ContentFrame>

### Include single counter:
    
Include a single counter using `IncludeCounter()`:
    
<Tabs groupId='languageSyntax'>
<TabItem value="Load" label="Load">
```csharp
using (var session = store.OpenSession())
{
    // Load document "products/1-A"
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeCounter', pass the name of the counter to include
        includeBuilder.IncludeCounter("Likes"));    
    
    // The included counter is now cached in the session's memory.
    // Getting its value will NOT trigger a server request
    var productLikes = session
        .CountersFor("products/1-A")
        .Get("Likes");
    
    Console.WriteLine("Number of likes: " + productLikes);
}
```
</TabItem>
<TabItem value="Load_async" label="Loae_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Load document "products/1-A"
    var product = await asyncSession.LoadAsync<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeCounter', pass the name of the counter to include
        includeBuilder.IncludeCounter("Likes"));
    
    // The included counter is now cached in the session's memory.
    // Getting its value will NOT trigger a server request.
    var productLikes = await asyncSession
        .CountersFor("products/1-A")
        .GetAsync("Likes");
    
    Console.WriteLine("Number of likes: " + productLikes);
}
```
</TabItem>
</Tabs>

</ContentFrame>
    
<ContentFrame>

### Include multiple counters:
    
Include multiple counters using `IncludeCounters()`:
    
<Tabs groupId='languageSyntax'>
<TabItem value="Load" label="Load">
```csharp
using (var session = store.OpenSession())
{
    // Load document "products/1-A"
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeCounters', pass a list of the counter names to include
        includeBuilder.IncludeCounters(new[] { "Likes", "Downloads" }));
    
    // The included counters are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDownloads = session
        .CountersFor("products/1-A")
        .Get("Downloads");
    
    Console.WriteLine("Number of downloads: " + productDownloads);
}
```
</TabItem>
<TabItem value="Load_async" label="Load_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Load document "products/1-A"
    var product = await asyncSession.LoadAsync<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeCounters' and pass a list of counter names to include
        includeBuilder.IncludeCounters(new[] { "Likes", "Downloads" }));
    
    // The included counters are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDownloads = await asyncSession
        .CountersFor("products/1-A")
        .GetAsync("Downloads");
    
    Console.WriteLine("Number of downloads: " + productDownloads);
}
```
</TabItem>
</Tabs>

You can also include multiple counters by chaining multiple `IncludeCounter()` calls:
    
<Tabs groupId='languageSyntax'>
<TabItem value="Load" label="Load">
```csharp
using (var session = store.OpenSession())
{
    // Load document "products/1-A"
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        // Include multiple counters by chaining 'IncludeCounter' calls
        includeBuilder
            .IncludeCounter("Likes")
            .IncludeCounter("Downloads"));
    
    // The included counters are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDownloads = session
        .CountersFor("products/1-A")
        .Get("Downloads");
    
    Console.WriteLine("Number of downloads: " + productDownloads);
}
```
</TabItem>
<TabItem value="Load_async" label="Load_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Load document "products/1-A"
    var product = await asyncSession.LoadAsync<Product>("products/1-A", includeBuilder =>
        // Include multiple counters by chaining 'IncludeCounter' calls
        includeBuilder
            .IncludeCounter("Likes")
            .IncludeCounter("Downloads"));
    
    // The included counters are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDownloads = await asyncSession
        .CountersFor("products/1-A")
        .GetAsync("Downloads");
    
    Console.WriteLine("Number of downloads: " + productDownloads);
}
```
</TabItem>
</Tabs>
    
</ContentFrame>

<ContentFrame>
    
### Include all counters:
    
Include ALL counters using `IncludeAllCounters()`:
    
<Tabs groupId='languageSyntax'>
<TabItem value="Load" label="Load">
```csharp
using (var session = store.OpenSession())
{
    // Load document "products/1-A"
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeAllCounters' to include all counters
        includeBuilder.IncludeAllCounters());

    // All counters belonging to the document are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDislikes = session
        .CountersFor("products/1-A")
        .Get("Dislikes");
    
    Console.WriteLine("Number of dislikes: " + productDislikes);
}
```
</TabItem>
<TabItem value="Load_async" label="Load_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Load document "products/1-A"
    var product = await asyncSession.LoadAsync<Product>("products/1-A", includeBuilder =>
        // Call 'IncludeAllCounters' to include all counters
        includeBuilder.IncludeAllCounters());
    
    // All counters belonging to the document are now cached in the session's memory.
    // Getting their values will NOT trigger a server request.
    var productDislikes = await asyncSession
        .CountersFor("products/1-A")
        .GetAsync("Dislikes");
    
    Console.WriteLine("Number of dislikes: " + productDislikes);
}
```
</TabItem>
</Tabs>

</ContentFrame>
</Panel>

<Panel heading="Include counters when querying">

<ContentFrame>

### Include single counter:

Use `IncludeCounter()` to include a single counter for each resulting document.  
The counter with the specified name will be cached in the session's memory for each document returned.  
    
<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
```csharp
using (var session = store.OpenSession())
{
    // Query for product documents
    var products = session.Query<Product>()
         // Filter documents as needed
        .Where(x=> x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Include the "Likes" counter for each matching document
            includeBuilder.IncludeCounter("Likes"))
        .ToList();
    
    foreach (var product in products)
    {
        // Access the counters included in the session
        // Getting their values will NOT trigger a server request.
        var productLikes = session.CountersFor(product).Get("Likes");
    
        if (productLikes != null)
            Console.WriteLine($"Product '{product.Id}' has {productLikes} likes.");
        else
            Console.WriteLine($"Product '{product.Id}' has no 'Likes' counter.");
    }
}
```
</TabItem>
<TabItem value="Query_async" label="Query_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Query for product documents
    var products = await asyncSession.Query<Product>()
        // Filter documents as needed
        .Where(x => x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Include the "Likes" counter for each matching document
            includeBuilder.IncludeCounter("Likes"))
        .ToListAsync();

    foreach (var product in products)
    {
        // Access the counters included in the session
        // Getting their values will NOT trigger a server request.
        var productLikes = await asyncSession.CountersFor(product).GetAsync("Likes");

        if (productLikes != null)
            Console.WriteLine($"Product '{product.Id}' has {productLikes} likes.");
        else
            Console.WriteLine($"Product '{product.Id}' has no 'Likes' counter.");
    }
}
```
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
```csharp
using (var session = store.OpenSession())
{
    var products = session.Advanced.RawQuery<Product>(@"
            from Products as p
            where p.Supplier == 'suppliers/1-A'
            include counters(p, 'Likes')
        ")
        .ToList();

    foreach (var product in products)
    {
        var likes = session.CountersFor(product).Get("Likes");

        if (likes != null)
            Console.WriteLine($"Product '{product.Id}' has {likes} likes.");
        else
            Console.WriteLine($"Product '{product.Id}' has no 'Likes' counter.");
    }
}
```
</TabItem>
<TabItem value="RawQuery_async" label="RawQuery_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    var products = await asyncSession.Advanced.AsyncRawQuery<Product>(@"
            from Products as p
            where p.Supplier == 'suppliers/1-A'
            include counters(p, 'Likes')
        ")
        .ToListAsync();

    foreach (var product in products)
    {
        var likes = await asyncSession.CountersFor(product).GetAsync("Likes");

        if (likes != null)
            Console.WriteLine($"Product '{product.Id}' has {likes} likes.");
        else
            Console.WriteLine($"Product '{product.Id}' has no 'Likes' counter.");
    }
}
```
</TabItem>
<TabItem value="sql" label="RQL">
```sql
from "Products"
where Supplier == "suppliers/1-A"
include counters("Likes")
```
</TabItem>
</Tabs>

</ContentFrame>

<ContentFrame>

### Include multiple counters:
 
Use `IncludeCounters()` to include multiple counters for each resulting document.  
Counters with the specified names will be cached in the session's memory for each document returned.  

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
```csharp
using (var session = store.OpenSession())
{
    // Query for product documents
    var products = session.Query<Product>()
         // Filter documents as needed
        .Where(x=> x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Call 'IncludeCounters', pass a list of counter names to include
            // Alternatively, you can chain individual calls:
            // includeBuilder.IncludeCounter("Likes").IncludeCounter("Downloads")
            includeBuilder.IncludeCounters(new[] { "Likes", "Downloads" }))
        .ToList();
    
    foreach (var product in products)
    {
        // Access the counters included in the session
        // Getting their values will NOT trigger a server request.
        var productLikes = session.CountersFor(product).Get("Likes");
        var productDownloads = session.CountersFor(product).Get("Downloads");
    }
}
```
</TabItem>
<TabItem value="Query_async" label="Query_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Query for product documents
    var products = await asyncSession.Query<Product>()
        // Filter documents as needed
        .Where(x => x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Call 'IncludeCounters', pass a list of counter names to include
            // Alternatively, you can chain individual calls:
            // includeBuilder.IncludeCounter("Likes").IncludeCounter("Downloads")
            includeBuilder.IncludeCounters(new[] { "Likes", "Downloads" }))
        .ToListAsync();

    foreach (var product in products)
    {
        // Access the counters included in the session
        // Getting their values will NOT trigger a server request.
        var productLikes = await asyncSession.CountersFor(product).GetAsync("Likes");
        var productDownloads = await asyncSession.CountersFor(product).GetAsync("Downloads");
    }
}
```
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
```csharp
using (var session = store.OpenSession())
{
    var products = session.Advanced.RawQuery<Product>(@"
            from Products
            where Supplier == 'suppliers/1-A'
            include counters('Likes'), counters('Downloads')
        ")
        .ToList();

    foreach (var product in products)
    {
        var likes = session.CountersFor(product).Get("Likes");
        var downloads = session.CountersFor(product).Get("Downloads");
    }
}
```
</TabItem>
<TabItem value="RawQuery_async" label="RawQuery_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    var products = await asyncSession.Advanced.AsyncRawQuery<Product>(@"
            from Products
            where Supplier == 'suppliers/1-A'
            include counters('Likes'), counters('Downloads')
        ")
        .ToListAsync();

    foreach (var product in products)
    {
        var likes = await asyncSession.CountersFor(product).GetAsync("Likes");
        var downloads = await asyncSession.CountersFor(product).GetAsync("Downloads");
    }
}
```
</TabItem>
<TabItem value="sql" label="RQL">
```sql
from "Products" 
where Supplier = "suppliers/1-A"
include counters("Likes"), counters("Downloads")
```
</TabItem>
</Tabs>

</ContentFrame>

<ContentFrame>

### Include all counters:

Use `IncludeAllCounters()` to include ALL counters.  
All counters for each resulting document will be cached in the session's memory.
 
<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
```csharp
using (var session = store.OpenSession())
{
    // Query for product documents
    var products = session.Query<Product>()
        // Filter documents as needed
        .Where(x => x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Include ALL counters for each matching document
            includeBuilder.IncludeAllCounters())
        .ToList();

    foreach (var product in products)
    {
        // All counters for the resulting documents are now cached in the session's memory
        // Getting their values will NOT trigger a server request
        var productDislikes = session.CountersFor(product).Get("Dislikes");
    }
}
```
</TabItem>
<TabItem value="Query_async" label="Query_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    // Query for product documents
    var products = await asyncSession.Query<Product>()
        // Filter documents as needed
        .Where(x => x.Supplier == "suppliers/1-A")
        .Include(includeBuilder =>
            // Include ALL counters for each matching document
            includeBuilder.IncludeAllCounters())
        .ToListAsync();

    foreach (var product in products)
    {
        // All counters for the resulting documents are now cached in the session's memory
        // Getting their values will NOT trigger a server request
        var productDislikes = await asyncSession.CountersFor(product).GetAsync("Dislikes");
    }
}
```
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
```csharp
using (var session = store.OpenSession())
{
    var products = session.Advanced.RawQuery<Product>(@"
            from Products
            where Supplier == 'suppliers/1-A'
            include counters()
        ")
        .ToList();

    foreach (var product in products)
    {
        var productDislikes = session.CountersFor(product).Get("Dislikes");
    }
}
```
</TabItem>
<TabItem value="RawQuery_async" label="RawQuery_async">
```csharp
using (var asyncSession = store.OpenAsyncSession())
{
    var products = await asyncSession.Advanced.AsyncRawQuery<Product>(@"
            from Products
            where Supplier == 'suppliers/1-A'
            include counters()
        ")
        .ToListAsync();

    foreach (var product in products)
    {
        var productDislikes = await asyncSession.CountersFor(product).GetAsync("Dislikes");
    }
}
```
</TabItem>
<TabItem value="sql" label="RQL">
```sql
from "Products" 
where Supplier == "suppliers/1-A"
include counters()
```
</TabItem>
</Tabs>

</ContentFrame>
</Panel>

<Panel heading="Including multiple item types">

You can combine different include types **when loading or querying** a document using the fluent _includeBuilder_ syntax.  
For example, you can include counters, related documents, time series, compare-exchange values, or past revisions.  
This allows you to retrieve all related data in a single server call and avoid additional round trips later in the session.  

The order in which you chain the include methods does not matter. For example:  

<TabItem value="" label="">
```csharp
using (var session = store.OpenSession(new SessionOptions
{
    // Required when including compare-exchange values
    TransactionMode = TransactionMode.ClusterWide
}))
{
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        includeBuilder
             // include counter
            .IncludeCounter("Likes")
             // include related document
            .IncludeDocuments(x => x.Supplier) 
             // include time series
            .IncludeTimeSeries("HeartRates")
             // include compare-exchange value
            .IncludeCompareExchangeValue("document_property_that_holds_the_cmpxchg_Key")
             // include past revisions from last month
            .IncludeRevisions(DateTime.Now.AddMonths(-1))
        );
}
```
</TabItem>
</Panel>

<Panel heading="Include behavior and constraints">

The following sections describe behavior that applies when including counters - whether during **load or query**:
* [Counters that don't exist at include time](../../../document-extensions/counters/including-counters.mdx#counters-that-dont-exist-at-include-time)  
* [Do not mix IncludeAllCounters with individual counter includes](../../../document-extensions/counters/including-counters.mdx#do-not-mix-includeallcounters-with-individual-counter-includes)

---
    
### Counters that don't exist at include time

If you include a counter that does Not exist at the time of the load or query execution, this will not cause an error.  
However:  
* Its value will be null.
* Accessing it later in the same session will not trigger a server request, because the counter is already cached in the session’s internal state.
* Even if the counter is created after the _include_, no server call will be made when trying to access its value.
* To retrieve the counter in this case, you can:
  * Call [Clear](../../client-api/session/how-to/clear-a-session) to reset the session and discard all tracked state.
  * Use [Evict](../../client-api/session/how-to/evict-entity-from-a-session) to remove the document (and its cached counters) from the session’s internal state.
  * Or simply fetch the counter in a new session.  
    
<TabItem value="" label="">
```csharp
using (var session = store.OpenSession())
{
    // Load and include specific counters - one of them doesn't exist yet
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        includeBuilder.IncludeCounters(new[] { "Likes", "non-existent-counter" }));

    // ...ASSUME the counter "non-existent-counter" was just created *After* the above load
    
    // Trying to get the counter's value will NOT trigger a server call.
    // The counter is already cached in the session's internal state.
    var valueOfCounter = session.CountersFor(product).Get("non-existent-counter"); 
    Console.WriteLine("Value of counter: " + valueOfCounter);  // null 
    
    // You can call 'Evict' to remove the document (and its cached counters) from the session
    session.Advanced.Evict(product);

    // Now a server call will be made to fetch the counter.
    // Note:
    // * You must specify the document ID since the entity is no longer tracked
    // * Despite the name, "non-existent-counter" now exists on the server :)
    valueOfCounter = session.CountersFor("products/1-A").Get("non-existent-counter");
    Console.WriteLine("Value of counter: " + valueOfCounter);  // whatever the current value is 
}
```  
</TabItem> 

<TabItem value="" label="">
```csharp
using (var session = store.OpenSession())
{
    // Load and include ALL counters
    var product = session.Load<Product>("products/1-A", includeBuilder =>
        includeBuilder.IncludeAllCounters());

    // ...ASSUME the counter "new-counter" was just created *After* the above load
    
    // No server call is made here, even if "new-counter" exists now
    var valueOfCounter = session.CountersFor(product).Get("new-counter");
    Console.WriteLine("Value of counter: " + valueOfCounter);  // null
} 
```  
</TabItem> 
    
--- 
    
### Do not mix IncludeAllCounters with individual counter includes 
    
Once you've called `IncludeAllCounters()`, you cannot include individual counters using `IncludeCounter()` or `IncludeCounters()` in the same include chain.
Attempting to do so will throw an `InvalidOperationException` at runtime.    
    
<TabItem value="" label="">
```csharp
using (var session = store.OpenSession())
{
    session.Load<Product>("products/1-A", includeBuilder =>  includeBuilder
        .IncludeAllCounters()
        .IncludeCounter("Likes")); // This will throw
}
```  
</TabItem> 
</Panel>

<Panel heading="Syntax">

<TabItem value="" label="">
```csharp
// Available overloads:
IncludeCounter(string name);
IncludeCounters(string[] names);
IncludeAllCounters();

```
</TabItem>

| Parameter  | Type       | Description                              |
|------------|------------|------------------------------------------|
| **name**   | `string`   | The name of a single counter to include. |
| **names**  | `string[]` | An array of counter names to include.    |
    
</Panel>