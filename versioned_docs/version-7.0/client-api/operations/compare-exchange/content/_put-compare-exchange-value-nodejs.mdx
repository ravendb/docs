import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">


* Use the `PutCompareExchangeValueOperation` operation to either:
  * **Create** a new compare-exchange item  
  * **Update** the value or metadata of an existing compare-exchange item

* Compare-exchange items can also be managed via [advanced session](../../../../client-api/session/cluster-transaction/compare-exchange.mdx) methods 
  or from the [Studio](../../../../studio/database/documents/compare-exchange-view.mdx).
  
* In this page:  
  * [Create new cmpXchg item](../../../../client-api/operations/compare-exchange/put-compare-exchange-value.mdx#create-new-cmpxchg-item)  
  * [Create new cmpXchg item with metadata](../../../../client-api/operations/compare-exchange/put-compare-exchange-value.mdx#create-new-cmpxchg-item-with-metadata)  
  * [Update existing cmpXchg item](../../../../client-api/operations/compare-exchange/put-compare-exchange-value.mdx#update-existing-cmpxchg-item)
  * [Syntax](../../../../client-api/operations/compare-exchange/put-compare-exchange-value.mdx#syntax)

</Admonition>
## Create new cmpXchg item

<TabItem value="put_1" label="put_1">
<CodeBlock language="js">
{`// Create a new CmpXchg item:
// ==========================

// Define the put compare-exchange operation. Pass:
// * KEY: a new unique identifier (e.g. a user's email)
// * VALUE: an associated value (e.g. the user's name)
// * INDEX: pass '0' to indicate that this is a new key
const putCmpXchgOp = new PutCompareExchangeValueOperation("johnDoe@gmail.com", "John Doe", 0);

// Execute the operation by passing it to operations.send
const result = await documentStore.operations.send(putCmpXchgOp);

// Check results
const successful = result.successful; // Has operation succeeded
const indexForItem = result.index;    // The version number assigned to the new item

// If successful is true then a new compare-exchange item has been created
// with the unique email key and the associated value.
`}
</CodeBlock>
</TabItem>

* Note:  
  Using `0` with a key that already exists will Not modify existing compare-exchange item.



## Create new cmpXchg item with metadata

<TabItem value="put_2" label="put_2">
<CodeBlock language="js">
{`// Create a new CmpXchg item with metadata:
// ========================================

// Define the put compare-exchange operation.
// Pass a 4'th parameter with the metadata object.
const putCmpXchgOp = new PutCompareExchangeValueOperation("+48-123-456-789", "John Doe", 0,
    \{ 
        "Provider": "T-Mobile",
        "Network": "5G",
        "Work phone": false
    \});

// Execute the operation by passing it to operations.send
const result = await documentStore.operations.send(putCmpXchgOp);

// Check results
const successful = result.successful; // Has operation succeeded
const indexForItem = result.index;    // The version number assigned to the new item

// If successful is true then a new compare-exchange item has been created
// with the unique phone number key, value, and metadata.
`}
</CodeBlock>
</TabItem>

* Find more examples of adding metadata to a compare-exchange item in [compare-exchange metadata](../../../../client-api/operations/compare-exchange/compare-exchange-metadata.mdx).



## Update existing cmpXchg item

* When calling `PutCompareExchangeValueOperation`,  
  the index from the request is compared to the index that is currently stored in the server for the specified _key_.
* The compare-exchange item is updated only if the two are equal.

<TabItem value="put_3" label="put_3">
<CodeBlock language="js">
{`// Modify an existing CmpXchg item:
// ================================

// Get the existing compare-exchange item
const item = await documentStore.operations.send(
    new GetCompareExchangeValueOperation("+48-123-456-789")
);

// Make some changes
const newValue = "Jane Doe";
const metadata = item.metadata;
metadata["Work phone"] = true;

// Update the compare-exchange item:
// The put operation will succeed only if the 'index' of the compare-exchange item
// has not changed between the read and write operations.
const result = await documentStore.operations.send(
    new PutCompareExchangeValueOperation("+48-123-456-789", newValue, item.index, metadata)
);

// Check results
const successful = result.successful; // Has operation succeeded
const newIndex = result.index;        // The new version number assigned to the item 

// Version has increased
assert(newIndex > item.index);
`}
</CodeBlock>
</TabItem>



## Syntax

<TabItem value="syntax_1" label="syntax_1">
<CodeBlock language="js">
{`// Available overloads:
// ====================
const putCmpXchgOp = new PutCompareExchangeValueOperation(key, value, index);
const putCmpXchgOp = new PutCompareExchangeValueOperation(key, value, index, metadata);
`}
</CodeBlock>
</TabItem>

| Parameter     | Type        | Description                                                                                                                                 |
|---------------|-------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **key**       | `string`    | &lt;ul&gt;&lt;li&gt;A unique identifier in the database scope.&lt;/li&gt;&lt;li&gt;Can be up to 512 bytes.&lt;/li&gt;&lt;ul&gt;                                                 |
| **value**     | `object`    | &lt;ul&gt;&lt;li&gt;A value to be saved for the specified _key_.&lt;/li&gt;&lt;li&gt;Can be any object (number, string, array, or any valid JSON object).&lt;/li&gt;&lt;/ul&gt; |
| **index**     | `number`    | &lt;ul&gt;&lt;li&gt;Pass `0` to create a new key.&lt;/li&gt;&lt;li&gt;When updating an existing key, pass the current number for concurrency control.&lt;/li&gt;&lt;ul&gt;      |
| **metadata**  | `object`    | &lt;ul&gt;&lt;li&gt;Metadata to be saved for the specified _key_.&lt;/li&gt;&lt;li&gt;Must be a valid JSON object.&lt;/li&gt;&lt;/ul&gt;                                        |

<TabItem value="syntax_2" label="syntax_2">
<CodeBlock language="js">
{`// Return value of store.operations.send(putCmpXchgOp)
// ===================================================
class CompareExchangeResult \{
    successful;
    value;
    index;
\}
`}
</CodeBlock>
</TabItem>

| Return Value   | Type      | Description                                                                                                                                                                                                                                                                                                     |
|----------------|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **successful** | `boolean` | &lt;ul&gt;&lt;li&gt;`true` if the put operation has completed successfully.&lt;/li&gt;&lt;li&gt;`false` if the put operation has failed.&lt;/li&gt;&lt;/ul&gt;                                                                                                                                                                                      |
| **value**      | `object`  | &lt;ul&gt;&lt;li&gt;Upon success - the value of the compare-exchange item that was saved.&lt;/li&gt;&lt;li&gt;Upon failure - the existing value on the server.&lt;/li&gt;&lt;/ul&gt;                                                                                                                                                                |
| **index**      | `number`  | &lt;ul&gt;&lt;li&gt;The compare-exchange item's version.&lt;/li&gt;&lt;li&gt;This number increases with each successful modification of the `value` or `metadata`.&lt;/li&gt;&lt;li&gt;Upon success - the updated version of the compare-exchange item that was saved.&lt;/li&gt;&lt;li&gt;Upon failure - the existing version number in the server.&lt;/li&gt;&lt;/ul&gt; |




