import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Compare-Exchange items can be created and managed on the advanced session (`Session.Advanced`)  
  Other options are listed in this [compare-exchange overview](../../../../client-api/operations/compare-exchange/overview.mdx#how-to-create-and-manage-compare-exchange-items).

* When working with compare-exchange items from the session,  
  the session **must be opened as a [cluster-wide session](../../../../client-api/session/cluster-transaction/overview.mdx#open-a-cluster-transaction)**.

* In this page:
    * [Create compare-exchange](../../../../client-api/session/cluster-transaction/compare-exchange.mdx#create-compare-exchange)
    * [Get compare-exchange](../../../../client-api/session/cluster-transaction/compare-exchange.mdx#get-compare-exchange)
    * [Delete compare-exchange](../../../../client-api/session/cluster-transaction/compare-exchange.mdx#delete-compare-exchange)
</Admonition>
## Create compare-exchange

<Admonition type="note" title="">
#### Example

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`// The session must be first opened with cluster-wide mode
session.Advanced.ClusterTransaction.CreateCompareExchangeValue(
    key: "Best NoSQL Transactional Database",
    value: "RavenDB"
);

session.SaveChanges();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`// The session must be first opened with cluster-wide mode
session.Advanced.ClusterTransaction.CreateCompareExchangeValue(
    key: "Best NoSQL Transactional Database",
    value: "RavenDB"
);

await session.SaveChangesAsync();
`}
</CodeBlock>
</TabItem>
</Tabs>

* `SaveChanges()` throws a `ConcurrencyException` if the key already exists.
* An `InvalidOperationException` exception is thrown if the session was Not opened as **cluster-wide**.

</Admonition>

<Admonition type="note" title="">
#### Syntax

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`session.Advanced.ClusterTransaction.CreateCompareExchangeValue<T>(key, value);
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`session.Advanced.ClusterTransaction.CreateCompareExchangeValue<T>(key, value);
`}
</CodeBlock>
</TabItem>
</Tabs>

| Parameters   | Type     | Description                                                        |
|--------------|----------|--------------------------------------------------------------------|
| **key**      | `string` | The compare-exchange item key. This string can be up to 512 bytes. |
| **value**    | `T`      | The associated value to store for the key                          |

| Return Value              | Description                               |
|---------------------------|-------------------------------------------|
| `CompareExchangeValue<T>` | The new compare-exchange item is returned |
</Admonition>

<Admonition type="note" title="">
#### The CompareExchangeValue

| Parameters   | Type     | Description                                                        |
|--------------|----------|--------------------------------------------------------------------|
| **key**      | `string` | The compare-exchange item key. This string can be up to 512 bytes. |
| **value**    | `T`      | The value associated with the key                                  |
| **index**    | `long`   | Index for concurrency control                                      |

</Admonition>


## Get compare-exchange

<Admonition type="note" title="">
#### Get single value

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`session.Advanced.ClusterTransaction.GetCompareExchangeValue<T>(key);
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`await session.Advanced.ClusterTransaction.GetCompareExchangeValueAsync<T>(key);
`}
</CodeBlock>
</TabItem>
</Tabs>

| Parameters   | Type     | Description         |
|--------------|----------|---------------------|
| **key**      | `string` | The key to retrieve |

| Return Value | Description |
| ------------- | ----- |
| `CompareExchangeValue<T>`| If the key doesn't exist it will return `null` |

</Admonition>

<Admonition type="note" title="">
#### Get multiple values

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`session.Advanced.ClusterTransaction.GetCompareExchangeValues<T>(keys);
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`await session.Advanced.ClusterTransaction.GetCompareExchangeValuesAsync<T>(keys);
`}
</CodeBlock>
</TabItem>
</Tabs>

| Parameters   | Type       | Description               |
|--------------|------------|---------------------------|
| **keys**     | `string[]` | Array of keys to retrieve |

| Return Value | Description |
| ------------- | ----- |
| `Dictionary<string, CompareExchangeValue<T>>` | If a key doesn't exists the associate value will be `null` |
</Admonition>

<Admonition type="note" title="">
#### Get compare-exchange lazily

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`// Single value
session.Advanced.ClusterTransaction.Lazily.GetCompareExchangeValue<T>(key);

// Multiple values
session.Advanced.ClusterTransaction.Lazily.GetCompareExchangeValues<T>(keys);
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`// Single value
session.Advanced.ClusterTransaction.Lazily.GetCompareExchangeValueAsync<T>(key);

// Multiple values
session.Advanced.ClusterTransaction.Lazily.GetCompareExchangeValuesAsync<T>(keys);
`}
</CodeBlock>
</TabItem>
</Tabs>

| Parameters  | Type       | Description               |
|-------------|------------|---------------------------|
| **key**     | `string`   | The key to retrieve       |
| **keys**    | `string[]` | Array of keys to retrieve |

| Return Value | Description |
| ------------- | ----- |
| `Lazy<CompareExchangeValue<T>>`| If the key doesn't exist it will return `null` |
| `Lazy<Dictionary<string, CompareExchangeValue<T>>>` | If a key doesn't exists the associate value will be `null` |
</Admonition>


## Delete compare-exchange

<Admonition type="note" title="">

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`// Delete by key & index
session.Advanced.ClusterTransaction.DeleteCompareExchangeValue(key, index);

// Delete by compare-exchange item
session.Advanced.ClusterTransaction.DeleteCompareExchangeValue<T>(item);
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`// Delete by key & index
session.Advanced.ClusterTransaction.DeleteCompareExchangeValue(key, index);

// Delete by compare-exchange item
session.Advanced.ClusterTransaction.DeleteCompareExchangeValue<T>(item);
`}
</CodeBlock>
</TabItem>
</Tabs>

| Parameters | Type                      | Description                                    |
|------------|---------------------------|------------------------------------------------|
| **key**    | `string`                  | The key of the compare-exchange item to delete |
| **index**  | `long`                    | The index of this compare-exchange item        |
| **item**   | `CompareExchangeValue<T>` | The compare-exchange item to delete            |

</Admonition>



