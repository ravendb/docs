import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import ContentFrame from '@site/src/components/ContentFrame';
import Panel from '@site/src/components/Panel';

<Admonition type="note" title="">

* Queries in RavenDB can be written with either of the following:
   * Using a rich API via the session's `query` method  
   * Using the [document_query](../client-api/session/querying/document-query/query-vs-document-query.mdx) method  
   * Using **RQL** -  
      - when querying via the session's `raw_query` method  
      - when querying from the Studio's [Query view](../studio/database/queries/query-view.mdx)  

* Queries defined with `query` or `document_query` are translated by the RavenDB client to [RQL](../client-api/session/querying/what-is-rql.mdx)  
  when sent to the server.
    
* All queries in RavenDB use an **index** to provide results, even when you don't specify one.  
  Learn more [below](../client-api/session/querying/how-to-query.mdx#queries-always-provide-results-using-an-index).

* Queries that do Not specify which index to use are called **Dynamic Queries**.  
  This article displays examples of dynamic queries only.  
  For examples showing how to query an index see [querying an index](../indexes/querying/query-index.mdx).
    
* The entities returned by the query are 'loaded' and **tracked** by the [Session](../client-api/session/what-is-a-session-and-how-does-it-work.mdx).  
  Entities will Not be tracked when:  
    * Query returns a [projection](../client-api/session/querying/how-to-project-query-results.mdx)  
    * Tracking is [disabled](../client-api/session/configuration/how-to-disable-tracking.mdx#disable-tracking-query-results)  

* Query results are **cached** by default. To disable query caching see [NoCaching](../client-api/session/querying/how-to-customize-query.mdx#nocaching).

* Queries are timed out after a configurable time period.  See [query timeout](../server/configuration/database-configuration.mdx#databasesquerytimeoutinsec).
    
* In this aricle:
  * [Queries always provide results using an index](../client-api/session/querying/how-to-query.mdx#queries-always-provide-results-using-an-index)  
  * [session.query](../client-api/session/querying/how-to-query.mdx#session-query)  
  * [session.advanced.document_query](../client-api/session/querying/how-to-query.mdx#session-advanced-document_query)  
  * [session.advanced.raw_query](../client-api/session/querying/how-to-query.mdx#session-advanced-raw_query)
  * [Custom methods](../client-api/session/querying/how-to-query.mdx#custom-methods)  
  * [Syntax](../client-api/session/querying/how-to-query.mdx#syntax)  

</Admonition>

<Panel heading="Queries always provide results using an index">

* Queries always use an index to provide fast results regardless of the size of your data.

* When a query reaches a RavenDB instance, the instance calls its query optimizer to analyze the query  
  and determine which index should be used to retrieve the requested data.

* Indexes allow to provide query results without scanning the entire dataset each and every time.
    * Learn more about indexes, their general concept, and the different **index types** in this [indexes overview](../studio/database/indexes/indexes-overview.mdx) article.
    * You can choose the underlying **search engine** that will be used by the RavenDB indexes.  
      Learn more in [selecting the search engine](../indexes/search-engine/corax.mdx#selecting-the-search-engine).

<Admonition type="info" title="">

We differentiate between the following **3 query scenarios**:

1. [Index query](../client-api/session/querying/how-to-query.mdx#indexquery)
2. [Dynamic query](../client-api/session/querying/how-to-query.mdx#dynamicquery)
3. [Full collection query](../client-api/session/querying/how-to-query.mdx#collectionquery)

For each scenario, a different index type is used, as described below.

</Admonition>
<Admonition type="note" title="">

<a id="indexQuery"/> 
**1. Query an existing index**:

*  **Query type**: Index query  
   **Index used**: Static-index  

* You can specify which **STATIC-index** the query will use.

* Static indexes are defined by the user, as opposed to auto-indexes that are created by the server  
  when querying a collection with some filtering applied. See [Static-index vs Auto-index](../studio/database/indexes/indexes-overview.mdx#auto-indexes--vs--static-indexes).  

* Example RQL: &nbsp; `from index "Employees/ByFirstName" where FirstName == "Laura"`  
  See more examples in [querying an index](../indexes/querying/query-index.mdx).

</Admonition>
<Admonition type="note" title="">

<a id="dynamicQuery"/> 
**2. Query a collection - with filtering**:  

*  **Query type**: Dynamic Query  
   **Index used**: Auto-index  

* When querying a collection without specifying an index and with some filtering condition  
  (other than just the document ID) the query-optimizer will analyze the query to see if an **AUTO-index**  
  that can answer the query already exists, i.e. an auto-index on the collection queried with index-fields that match those queried.  

* If such auto-index (Not a static one...) is found, it will be used to fetch the results.  

* Else, if no relevant auto-index is found,  
  the query-optimizer will create a new auto-index with fields that match the query criteria.  
  At this time, and only at this time, the query will wait for the auto-indexing process to complete.  
  Subsequent queries that target this auto-index will be served immediately.  

* Note: if there exists an auto-index that is defined on the collection queried  
  but is indexing a different field than the one queried on,  
  then the query-optimizer will create a new auto-index that merges both the  
  fields from the existing auto-index and the new fields queried.

* Once the newly created auto-index is done indexing the data,  
  the old auto-index is removed in favor of the new one.

* Over time, an optimal set of indexes is generated by the query optimizer to answer your queries.

* Example RQL: &nbsp; `from Employees where FirstName == "Laura"`  
  See more examples [below](../client-api/session/querying/how-to-query.mdx#sessionquery).
* Note: Counters and Time series are an exception to this flow.  
  Dynamic queries on counters and time series values don't create auto-indexes.  
  However, a static-index can be defined on [Time series](../document-extensions/timeseries/indexing.mdx) and [Counters](../document-extensions/counters/indexing.mdx).

</Admonition>
<Admonition type="note" title="">

<a id="collectionQuery"/> 
**3. Query a collection - query full collection | query by ID**:  
 
* **Query type**: Full collection Query  
  **Index used**: The raw collection (internal storage indexes)  

* Full collection query:

  * When querying a collection without specifying an index and with no filtering condition,  
    then all documents from the specified collection are returned.

  * RavenDB uses the raw collection documents in its **internal storage indexes** as the source for this query.  
    No auto-index is created.
   
  * Example RQL: &nbsp; `from Employees`

* Query by document ID:
 
  * When querying a collection only by document ID or IDs,  
    then similar to the full collection query, no auto-index is created.  
  
  * RavenDB uses the raw collection documents as the source for this query.  

  * Example RQL: &nbsp; `from Employees where id() == "employees/1-A"`  
    See more examples [below](../client-api/session/querying/how-to-query.mdx#sessionquery).

</Admonition>

</Panel>

<Panel heading="session.query">

* The simplest way to issue a query is using session's `query` method.  

* The following examples show **dynamic queries** that do not specify which index to use.  
  Please refer to [querying an index](../indexes/querying/query-index.mdx) for other examples.

* Querying can be enhanced using these [extension methods](../client-api/session/querying/how-to-query.mdx#custom-methods-and-extensions-for-linq).
 
<ContentFrame>

**Query collection - no filtering** 

<Tabs groupId='languageSyntax'>
<TabItem value="Method-syntax" label="Method-syntax">
```python
# This is a Full Collection Query
# No auto-index is created since no filtering is applied

all_employees = list(  # Execute the query
    session.query(object_type=Employee)  # Query for all documents from 'Employees' collection
)
```
</TabItem>
<TabItem value="Query-syntax" label="Query-syntax">
```python
# This is a Full Collection Query
# No auto-index is created since no filtering is applied

# Query for all documents from 'Employees' collection
query = session.query(object_type=Employee)

# Execute the query
all_employees = list(query)

# All 'Employee' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
// This RQL is a Full Collection Query
// No auto-index is created since no filtering is applied

from "Employees"
```
</TabItem>
</Tabs>

</ContentFrame>

<ContentFrame>
    
**Query collection - by ID**

<Tabs groupId='languageSyntax'>
<TabItem value="Method-syntax" label="Method-syntax">
```python
# Query collection by document ID
# No auto-index is created when querying only by ID

employee = (
    session.query(object_type=Employee)
    .where_equals("Id", "employees/1-A")  # Query for specific document from 'Employees' collection
    .first()  # Execute the query
)

# The resulting 'Employee' entity is loaded and will be tracked by the session
```
</TabItem>
<TabItem value="Query-syntax" label="Query-syntax">
```python
# Query collection by document ID
# No auto-index is created when querying only by ID

# Query for specific document from 'Employees' collection
query = session.query(object_type=Employee).where_equals("Id", "employees/1-A")

# Execute the query
employee_result = query.first()

# The resulting 'Employee' entity is loaded and will be tracked by the session
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
// This RQL queries the 'Employees' collection by ID
// No auto-index is created when querying only by ID

from "Employees" where id() == "employees/1-A"
```
</TabItem>
</Tabs>

</ContentFrame>

<ContentFrame>

**Query collection - with filtering** 

<Tabs groupId='languageSyntax'>
<TabItem value="Method-syntax" label="Method-syntax">
```python
# Query collection - filter by document field

# An auto-index will be created if there isn't already an existing auto-index
# that indexes this document field

employees = list(  # Execute the query
    session.query(object_type=Employee).where_equals(
        "first_name", "Robert"
    )  # Query for all 'Employee' documents that match this predicate
)

# The resulting 'Employee' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="Query-syntax" label="Query-syntax">
```python
# Query collection - filter by document field

# An auto-index will be created if there isn't already an existing auto-index
# that indexes this document field

# Query for all 'Employee' documents that match this predicate
query = session.query(object_type=Employee).where_equals("first_name", "Robert")

# Execute the query
employees = list(query)

# The resulting 'Employee' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
// Query collection - filter by document field

// An auto-index will be created if there isn't already an existing auto-index
// that indexes the requested field

from "Employees" where FirstName == "Robert"
```
</TabItem>
</Tabs>

</ContentFrame>

<ContentFrame>

**Query collection - with paging** 

<Tabs groupId='languageSyntax'>
<TabItem value="Method-syntax" label="Method-syntax">
```python
# Query collection - page results
# No auto-index is created since no filtering is applied
    
products = list(
    session.query(object_type=Product)
    .skip(5)   # Skip first 5 results
    .take(10)  # Load up to 10 entities from 'Products' collection
)

# The resulting 'Product' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="Query-syntax" label="Query-syntax">
```python
# Query collection - page results
# No auto-index is created since no filtering is applied

query = (
    session.query(object_type=Product).skip(5).take(10)  # Skip first 5 results
)  # Load up to 10 entities from 'Products' collection

# Execute the query
products = list(query)

# The resulting 'Product' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
// Query collection - page results
// No auto-index is created since no filtering is applied

from "Products" limit 5, 10 // skip 5, take 10
```
</TabItem>
</Tabs>

* By default, if the page size is not specified, all matching records will be retrieved from the database.

</ContentFrame>
    
</Panel>

<Panel heading="session.advanced.document_query">

* Below is a simple `document_query` usage sample and its RQL equivalent.  
  For a full description and more examples see:  
   * [What is a document query](../client-api/session/querying/document-query/what-is-document-query.mdx)
   * [query -vs- document_query](../client-api/session/querying/document-query/query-vs-document-query.mdx)

**Example**:

<Tabs groupId='languageSyntax'>
<TabItem value="document_query" label="document_query">
```python
# Query with document_query - filter by document field

# An auto-index will be created if there isn't already an existing auto-index
# that indexes this document field

employees = list(  # Execute the query
    session.advanced.document_query(object_type=Employee).where_equals(  # Use document_query
        "first_name", "Robert"
    )  # Query for all 'Employee' documents that match this predicate
)

# The resulting 'Employee' entities are loaded and will be tracked by the session
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
// Query collection - filter by document field

// An auto-index will be created if there isn't already an existing auto-index
// that indexes the requested field

from "Employees" where FirstName = "Robert"
```
</TabItem>
</Tabs>

</Panel>

<Panel heading="session.advanced.raw_query">

* Queries defined with [query](../client-api/session/querying/how-to-query.mdx#sessionquery) or [document_query](../client-api/session/querying/how-to-query.mdx#sessionadvanceddocument_query) are translated by the RavenDB client to [RQL](../client-api/session/querying/what-is-rql.mdx)  
  when sent to the server.

* The session also gives you a way to express the query directly in RQL using the `raw_query` method.

**Example**:

<Tabs groupId='languageSyntax'>
<TabItem value="RawQuery" label="RawQuery">
```python
# Query with RawQuery - filter by document field

# An auto-index will be created if there isn't already an existing auto-index
# that indexes this document field

employees = list(  # Execute the query
    session.advanced.raw_query(
        "from 'Employees' where first_name = 'Robert'", object_type=Employee
    )  # Provide RQL to RawQuery
)
# The resulting 'Employee' entities are loaded and will be tracked by the session
```
</TabItem>
</Tabs>

</Panel>

<Panel heading="Custom methods">

Available custom methods for session's [query](../client-api/session/querying/how-to-query.mdx#sessionquery) method:

- [aggregate_by](../client-api/session/querying/how-to-perform-a-faceted-search.mdx)
- [count](../client-api/session/querying/how-to-count-query-results.mdx)
- [count_lazily](../client-api/session/querying/how-to-perform-queries-lazily.mdx)
- [customize](../client-api/session/querying/how-to-customize-query.mdx)
- [highlight](../client-api/session/querying/text-search/highlight-query-results.mdx)
- [include](../client-api/how-to/handle-document-relationships.mdx)
- [intersect](../client-api/session/querying/how-to-use-intersect.mdx)
- [lazily](../client-api/session/querying/how-to-perform-queries-lazily.mdx)
- [long_count](../client-api/session/querying/how-to-count-query-results.mdx)
- [more_like_this](../client-api/session/querying/how-to-use-morelikethis.mdx)
- [of_type](../client-api/session/querying/how-to-project-query-results.mdx#oftype-(as)---simple-projection)
- [order_by_distance](../client-api/session/querying/how-to-make-a-spatial-query.mdx#orderbydistance)
- [order_by_distance_descending](../client-api/session/querying/how-to-make-a-spatial-query.mdx#orderbydistancedesc)
- [order_by_score](../client-api/session/querying/sort-query-results.mdx#order-by-score)
- [order_by_score_descending](../client-api/session/querying/sort-query-results.mdx#order-by-score)
- [project_into](../client-api/session/querying/how-to-project-query-results.mdx)
- [search](../client-api/session/querying/text-search/full-text-search.mdx)
- [spatial](../client-api/session/querying/how-to-make-a-spatial-query.mdx)
- [statistics](../client-api/session/querying/how-to-get-query-statistics.mdx)
- [suggest_using](../client-api/session/querying/how-to-work-with-suggestions.mdx)

</Panel>

<Panel heading="Syntax">

<TabItem value="syntax" label="syntax">
```python
# Overloads for querying a collection OR an index:
# ================================================

def query(
    self, source: Optional[Query] = None, object_type: Optional[Type[_T]] = None
) -> DocumentQuery[_T]:
    ...

def query_collection(
    self, collection_name: str, object_type: Optional[Type[_T]] = None
) -> DocumentQuery[_T]:
    ...

def query_index(self, index_name: str, object_type: Optional[Type[_T]] = None) -> DocumentQuery[_T]:
    ...

def document_query(
    self,
    index_name: str = None,
    collection_name: str = None,
    object_type: Type[_T] = None,
    is_map_reduce: bool = False,
) -> DocumentQuery[_T]:
    ...

# Overloads for querying an index:
# ================================
def query_index_type(
    self, index_type: Type[_TIndex], object_type: Optional[Type[_T]] = None
) -> DocumentQuery[_T]:
    ...

def document_query_from_index_type(
    self, index_type: Type[_TIndex], object_type: Type[_T]
) -> DocumentQuery[_T]:
    ...

# RawQuery
# ================================
def raw_query(self, query: str, object_type: Optional[Type[_T]] = None) -> RawDocumentQuery[_T]:
    ...
```
</TabItem>

| Parameter | Type | Description |
|--------------------|--------|------------------------------------------|
| **object_type** | `Type[_T]` | Queried entities type |
| **collection_name** | `str` | Queried collection name |
| **query** | `str` | RQL query string |
| **index_name** | `str` | Queried index name |
| **index_type** | `Type[_TIndex]` | Queried index type |
| **is_map_reduce** | `bool` | Is a map-reduce index queried |

| Return Value | |
| - | - |
| `DocumentQuery[_T]`<br/>`RawDocumentQuery[_T]` | Instances exposing additional query methods and [extensions](../client-api/session/querying/how-to-query.mdx#custom-methods-and-extensions-for-linq) |

</Panel>