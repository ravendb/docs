import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Documents that contain spatial data can be queried by spatial queries that employ geographical criteria.  
  You have two options:

    * **Dynamic spatial query**  
      Either make a dynamic spatial query on a collection (see [how to make a spatial query](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx)).  
      An auto-index will be created by the server.

    * **Spatial index query**  
      Or, index your documents' spatial data in a static-index (see [indexing spatial data](../../../indexes/indexing-spatial-data.mdx))  
      and then make a spatial query on this index ( **described in this article** ).

* A few examples of querying a spatial index are provided below.  
  **A spatial query performed on a static-index is similar to the** [dynamic spatial query](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx).  
  Find all spatial API methods listed [here](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx#spatial-api).  

* Examples in this page:
    * [Search by radius](../../../indexes/querying/spatial.mdx#search-by-radius)
    * [Search by shape](../../../indexes/querying/spatial.mdx#search-by-shape)
    * [Sort results](../../../indexes/querying/spatial.mdx#sort-results)

</Admonition>
## Search by radius

* Query the spatial index:

* Use the `withinRadius` method to search for all documents containing spatial data that is located  
  within the specified distance from the given center point.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="php">
{`// Define a spatial query on index 'Events_ByNameAndCoordinates'
/** @var array<Event> $employeesWithinRadius */
$employeesWithinRadius = $session
    ->query(Event::class, Events_ByNameAndCoordinates::class)
     // Call 'Spatial' method
    ->spatial(
        // Pass the spatial index-field containing the spatial data
        "Coordinates",
        // Set the geographical area in which to search for matching documents
        // Call 'withinRadius', pass the radius and the center points coordinates
        function ($criteria) { return $criteria->withinRadius(20, 47.623473, -122.3060097); })
    ->toList();

// The query returns all matching Event entities
// that are located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).
`}
</CodeBlock>
</TabItem>
<TabItem value="documentQuery" label="documentQuery">
<CodeBlock language="php">
{`// Define a spatial query on index 'Events_ByNameAndCoordinates'
$employeesWithinRadius = $session->advanced()
    ->documentQuery(Event::class, Events_ByNameAndCoordinates::class)
     // Call 'Spatial' method
    ->spatial(
        // Pass the spatial index-field containing the spatial data
        "Coordinates",
        // Set the geographical area in which to search for matching documents
        // Call 'WithinRadius', pass the radius and the center points coordinates
        function($criteria) { return $criteria->withinRadius(20, 47.623473, -122.3060097); })
    ->toList();

// The query returns all matching Event entities
// that are located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="php">
{`class Event
{
    private ?string $id = null;
    private ?string $name = null;
    private ?float $latitude = null;
    private ?float $longitude = null;

    public function getId(): ?string
    {
        return $this->id;
    }

    public function setId(?string $id): void
    {
        $this->id = $id;
    }

    public function getName(): ?string
    {
        return $this->name;
    }

    public function setName(?string $name): void
    {
        $this->name = $name;
    }

    public function getLatitude(): ?float
    {
        return $this->latitude;
    }

    public function setLatitude(?float $latitude): void
    {
        $this->latitude = $latitude;
    }

    public function getLongitude(): ?float
    {
        return $this->longitude;
    }

    public function setLongitude(?float $longitude): void
    {
        $this->longitude = $longitude;
    }
}

class Events_ByNameAndCoordinates extends AbstractIndexCreationTask
{
    public function __construct()
    {
        parent::__construct();

        $this->map = "docs.Events.Select(e => new { " .
            "    name = e.name, " .
            "    coordinates = this.CreateSpatialField(((double ? ) e.latitude), ((double ? ) e.longitude)) " .
            "})";
    }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from index "Events/ByNameAndCoordinates"
where spatial.within(
    Coordinates,
    spatial.circle(20, 47.623473, -122.3060097)
)

// The query returns all matching Event entities
// that are located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).
`}
</CodeBlock>
</TabItem>
</Tabs>



## Search by shape

* Query the spatial index:  
  Use the `RelatesToShape` method to search for all documents containing spatial data that is located  
  in the specified relation to the given shape.

* The shape in the query is specified as either a **circle** or a **polygon** in a WKT format.  
  See polygon rules [here](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx#polygonrules).

* The relation to the shape can be one of: `WITHIN`, `CONTAINS`, `DISJOINT`, `INTERSECTS`.

* See more usage examples in the [dynamic search by shape](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx#search-by-shape) query.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="php">
{`// Define a spatial query on index 'EventsWithWKT_ByNameAndWKT'
/** @var array<EventWithWKT> $employeesWithinShape */
$employeesWithinShape = $session
    ->query(EventWithWKT::class, EventsWithWKT_ByNameAndWKT::class)
    // Call 'spatial' method
    ->spatial(
        // Pass the spatial index-field containing the spatial data
        "WKT",
        // Set the geographical search criteria, call 'RelatesToShape'
        function($criteria) { return $criteria->relatesToShape(
            // Specify th   e WKT string
            "POLYGON ((
                           -118.6527948 32.7114894,
                           -95.8040242 37.5929338,
                           -102.8344151 53.3349629,
                           -127.5286633 48.3485664,
                           -129.4620208 38.0786067,
                           -118.7406746 32.7853769,
                           -118.6527948 32.7114894
                      ))",
            // Specify the relation between the WKT shape and the documents spatial data
            SpatialRelation::within()); })
    ->toList();

// The query returns all matching Event entities
// that are located within the specified polygon.
`}
</CodeBlock>
</TabItem>
<TabItem value="documentQuery" label="documentQuery">
<CodeBlock language="php">
{`// Define a spatial query on index 'EventsWithWKT_ByNameAndWKT'
/** @var array<EventWithWKT> $employeesWithinShape */
$employeesWithinShape = $session->advanced()
    ->documentQuery(EventWithWKT::class, EventsWithWKT_ByNameAndWKT::class)
    // Call 'Spatial' method
    ->spatial(
        // Pass the spatial index-field containing the spatial data
        "WKT",
        // Set the geographical search criteria, call 'RelatesToShape'
        function($criteria) { return $criteria->relatesToShape(
            // Specify the WKT string
            "POLYGON ((
                   -118.6527948 32.7114894,
                   -95.8040242 37.5929338,
                   -102.8344151 53.3349629,
                   -127.5286633 48.3485664,
                   -129.4620208 38.0786067,
                   -118.7406746 32.7853769,
                   -118.6527948 32.7114894
              ))",
            // Specify the relation between the WKT shape and the documents spatial data
            SpatialRelation::within()); })
    ->toList();

// The query returns all matching Event entities
// that are located within the specified polygon.
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="php">
{`class EventWithWKT {
    private ?string $id = null;
    private ?string $name = null;
    private ?string $wkt = null;

    public function getId(): ?string
    {
        return $this->id;
    }

    public function setId(?string $id): void
    {
        $this->id = $id;
    }

    public function getName(): ?string
    {
        return $this->name;
    }

    public function setName(?string $name): void
    {
        $this->name = $name;
    }

    public function getWkt(): ?string
    {
        return $this->wkt;
    }

    public function setWkt(?string $wkt): void
    {
        $this->wkt = $wkt;
    }
}

class EventsWithWKT_ByNameAndWKT extends AbstractIndexCreationTask
{
    public function __construct()
    {
        parent::__construct();

        $this->map = "docs.EventWithWKTs.Select(e => new { " .
            "    name = e.name, " .
            "    wkt = this.CreateSpatialField(e.wkt) " .
            "})";
    }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from index "EventsWithWKT/ByNameAndWKT"
where spatial.within(
    WKT,
    spatial.wkt("POLYGON ((
        -118.6527948 32.7114894,
        -95.8040242 37.5929338,
        -102.8344151 53.3349629,
        -127.5286633 48.3485664,
        -129.4620208 38.0786067,
        -118.7406746 32.7853769,
        -118.6527948 32.7114894))")
)

// The query returns all matching Event entities
// that are located within the specified polygon.
`}
</CodeBlock>
</TabItem>
</Tabs>

* Note:  
  The index in the above example indexes a WKT string in the spatial index-field.  
  However, you can query by shape also on spatial data that is indexed as lat/lng coordinates.  



## Sort results

* Query the spatial index:  
  Use `OrderByDistance` to sort the results by distance from a given point.

* By default, distance in RavenDB measured in **kilometers**.  
  The distance can be rounded to a specific range.  

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="php">
{`// Define a spatial query on index 'Events_ByNameAndCoordinates'
/** @var array<Event> $employeesSortedByDistance */
$employeesSortedByDistance = $session
    ->query(Event::class, Events_ByNameAndCoordinates::class)
     // Filter results by geographical criteria
    ->spatial(
        "Coordinates",
        function($criteria) { return $criteria->withinRadius(20, 47.623473, -122.3060097); })
     // Sort results, call 'OrderByDistance'
    ->orderByDistance(
        // Pass the spatial index-field containing the spatial data
        "Coordinates",
        // Sort the results by their distance from this point:
        47.623473, -122.3060097)
    ->toList();

// Return all matching Event entities located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).

// Sort the results by their distance from a specified point,
// the closest results will be listed first.
`}
</CodeBlock>
</TabItem>
<TabItem value="documentQuery" label="documentQuery">
<CodeBlock language="php">
{`// Define a spatial query on index 'Events_ByNameAndCoordinates'
/** @var array<Event> $employeesSortedByDistance */
$employeesSortedByDistance = $session->advanced()
    ->documentQuery(Event::class, Events_ByNameAndCoordinates::class)
     // Filter results by geographical criteria
    ->spatial(
        "Coordinates",
        function($criteria) { return $criteria->withinRadius(20, 47.623473, -122.3060097); })
     // Sort results, call 'OrderByDistance'
    ->orderByDistance(
        // Pass the spatial index-field containing the spatial data
        "Coordinates",
        // Sort the results by their distance from this point:
        47.623473, -122.3060097)
    ->toList();

// Return all matching Event entities located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).

// Sort the results by their distance from a specified point,
// the closest results will be listed first.
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="php">
{`class Event
{
    private ?string $id = null;
    private ?string $name = null;
    private ?float $latitude = null;
    private ?float $longitude = null;

    public function getId(): ?string
    {
        return $this->id;
    }

    public function setId(?string $id): void
    {
        $this->id = $id;
    }

    public function getName(): ?string
    {
        return $this->name;
    }

    public function setName(?string $name): void
    {
        $this->name = $name;
    }

    public function getLatitude(): ?float
    {
        return $this->latitude;
    }

    public function setLatitude(?float $latitude): void
    {
        $this->latitude = $latitude;
    }

    public function getLongitude(): ?float
    {
        return $this->longitude;
    }

    public function setLongitude(?float $longitude): void
    {
        $this->longitude = $longitude;
    }
}

class Events_ByNameAndCoordinates extends AbstractIndexCreationTask
{
    public function __construct()
    {
        parent::__construct();

        $this->map = "docs.Events.Select(e => new { " .
            "    name = e.name, " .
            "    coordinates = this.CreateSpatialField(((double ? ) e.latitude), ((double ? ) e.longitude)) " .
            "})";
    }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from index "Events/ByNameAndCoordinates"
where spatial.within(
    Coordinates,
    spatial.circle(20, 47.623473, -122.3060097)
)
order by spatial.distance(
    Coordinates,
    spatial.point(47.623473, -122.3060097)
)

// The query returns all matching Event entities located within 20 kilometers radius
// from point (47.623473 latitude, -122.3060097 longitude).

// Sort the results by their distance from a specified point,
// the closest results will be listed first.
`}
</CodeBlock>
</TabItem>
</Tabs>

* More sorting examples are available in the [dynamic spatial query](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx#spatial-sorting) article.

* To get the **distance** for each resulting entity see [get resulting distance](../../../client-api/session/querying/how-to-make-a-spatial-query.mdx#getresultingdistance).



## Syntax

<TabItem value="spatial_syntax_1" label="spatial_syntax_1">
<CodeBlock language="php">
{`object CreateSpatialField(double? lat, double? lng); // Latitude/Longitude coordinates
object CreateSpatialField(string shapeWkt);          // Shape in WKT string format
`}
</CodeBlock>
</TabItem>
<TabItem value="spatial_syntax_2" label="spatial_syntax_2">
<CodeBlock language="php">
{`class SpatialOptionsFactory
\{
    public function geography(): GeographySpatialOptionsFactory
    \{
        return new GeographySpatialOptionsFactory();
    \}

    public function cartesian(): CartesianSpatialOptionsFactory
    \{
        return new CartesianSpatialOptionsFactory();
    \}
\}
`}
</CodeBlock>
</TabItem>
<TabItem value="spatial_syntax_3" label="spatial_syntax_3">
<CodeBlock language="php">
{`interface GeographySpatialOptionsFactory
\{
    // if $circleRadiusUnits is not set SpatialUnits::kilometers() will be used

    // Default is GeohashPrefixTree strategy with maxTreeLevel set to 9
    public function defaultOptions(?SpatialUnits $circleRadiusUnits = null): SpatialOptions;

    public function boundingBoxIndex(?SpatialUnits $circleRadiusUnits = null): SpatialOptions;

    public function geohashPrefixTreeIndex(int $maxTreeLevel, ?SpatialUnits $circleRadiusUnits = null): SpatialOptions;

    public function quadPrefixTreeIndex(int $maxTreeLevel, ?SpatialUnits $circleRadiusUnits = null): SpatialOptions;
\}
`}
</CodeBlock>
</TabItem>
<TabItem value="spatial_syntax_4" label="spatial_syntax_4">
<CodeBlock language="php">
{`interface CartesianSpatialOptionsFactory
\{
    public function boundingBoxIndex(): SpatialOptions;
    public function quadPrefixTreeIndex(int $maxTreeLevel, SpatialBounds $bounds): SpatialOptions;
\}

class SpatialBounds
\{
    private float $minX;
    private float $maxX;
    private float $minY;
    private float $maxY;

    // ... getters and setters
\}
`}
</CodeBlock>
</TabItem>





