import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

Following query customization options are available in `IDocumentQueryCustomization` interface:

- [BeforeQueryExecution](../../../../client-api/session/querying/how-to-customize-query.mdx#beforequeryexecution)
- [CustomSortUsing](../../../../client-api/session/querying/how-to-customize-query.mdx#customsortusing)
- [Highlight](../../../../client-api/session/querying/how-to-customize-query.mdx#highlight)
- [Include](../../../../client-api/session/querying/how-to-customize-query.mdx#include)
- [NoCaching](../../../../client-api/session/querying/how-to-customize-query.mdx#nocaching)
- [NoTracking](../../../../client-api/session/querying/how-to-customize-query.mdx#notracking)
- [RandomOrdering](../../../../client-api/session/querying/how-to-customize-query.mdx#randomordering)
- [RelatesToShape](../../../../client-api/session/querying/how-to-customize-query.mdx#relatestoshape)
- [SetAllowMultipleIndexEntriesForSameDocumentToResultTransformer](../../../../client-api/session/querying/how-to-customize-query.mdx#setallowmultipleindexentriesforsamedocumenttoresulttransformer)
- [SetHighlighterTags](../../../../client-api/session/querying/how-to-customize-query.mdx#sethighlightertags)
- [ShowTimings](../../../../client-api/session/querying/how-to-customize-query.mdx#showtimings)
- [SortByDistance](../../../../client-api/session/querying/how-to-customize-query.mdx#sortbydistance)
- [Spatial](../../../../client-api/session/querying/how-to-customize-query.mdx#spatial)
- [TransformResults](../../../../client-api/session/querying/how-to-customize-query.mdx#transformresults)
- [WaitForNonStaleResults](../../../../client-api/session/querying/how-to-customize-query.mdx#waitfornonstaleresults)
- [WaitForNonStaleResultsAsOf](../../../../client-api/session/querying/how-to-customize-query.mdx#waitfornonstaleresultsasof)
- [WaitForNonStaleResultsAsOfLastWrite](../../../../client-api/session/querying/how-to-customize-query.mdx#waitfornonstaleresultsasoflastwrite)
- [WaitForNonStaleResultsAsOfNow](../../../../client-api/session/querying/how-to-customize-query.mdx#waitfornonstaleresultsasofnow)
- [WithinRadiusOf](../../../../client-api/session/querying/how-to-customize-query.mdx#withinradiusof)

## BeforeQueryExecution

Allows you to modify the index query just before it is executed.

<TabItem value="customize_1_0" label="customize_1_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization BeforeQueryExecuted(Action<IndexQuery> action);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **action** | Action&lt;[IndexQuery](../../../../glossary/index-query.mdx)&gt; | Action that will modify IndexQuery. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_1_1" label="customize_1_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'BeforeQueryExecuted'
    .Customize(x => x.BeforeQueryExecuted(query =>
    \{
        // Can modify query parameters
        query.SkipDuplicateChecking = true;
        // Can apply any needed action, e.g. write to log
        _logger.Info($"Query to be executed is: \{query.Query\}");
    \}))
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## CustomSortUsing

Allows you to use custom sorter on the server. Dedicated article can be found [here](../../../../indexes/querying/sorting.mdx#custom-sorting).

<TabItem value="customize_12_0" label="customize_12_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization CustomSortUsing(string typeName);

IDocumentQueryCustomization CustomSortUsing(string typeName, bool descending);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **typeName** | string | AssemblyQualifiedName of a custom sorter available on server-side. |
| **descending** | bool | indicates if results should be ordered descending or ascending |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |



## Highlight

Please check our dedicated [article](../../../../client-api/session/querying/how-to-use-highlighting.mdx).



## Include

Please check our dedicated [article](../../../../indexes/querying/handling-document-relationships.mdx).



## NoCaching

By default, queries are cached. To disable query caching use `NoCaching` customization.

<TabItem value="customize_2_0" label="customize_2_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization NoCaching();
`}
</CodeBlock>
</TabItem>

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_2_1" label="customize_2_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'AfterQueryExecuted'
    .Customize(x => x.AfterQueryExecuted(rawResult =>
    \{
        // Can access the raw query result
        var queryDuration = rawResult.DurationInMs;
        // Can apply any needed action, e.g. write to log
        _logger.Info($"\{rawResult.LastQueryTime\}");
    \}))
    .ToList();
`}
</CodeBlock>
</TabItem>



## NoTracking

To disable entity tracking by `Session` use `NoTracking`. Usage of this option will prevent holding query results in memory.

<TabItem value="customize_3_0" label="customize_3_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization NoTracking();
`}
</CodeBlock>
</TabItem>

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_3_1" label="customize_3_1">
<CodeBlock language="csharp">
{`long totalStreamedResultsSize = 0;

// Define the query
var query = session
    .Query<Employee>()
     // Call 'Customize' with 'AfterStreamExecuted'
    .Customize(x => x.AfterStreamExecuted(streamResult =>
        // Can access the stream result
        totalStreamedResultsSize += streamResult.Size));
    
// Call 'Stream' to execute the query
var streamResults = session.Advanced.Stream(query);
`}
</CodeBlock>
</TabItem>



## RandomOrdering

To order results randomly use `RandomOrdering` method.

<TabItem value="customize_4_0" label="customize_4_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization RandomOrdering();

IDocumentQueryCustomization RandomOrdering(string seed);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **seed** | string | Seed used for ordering. Useful when repeatable random queries are needed. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_4_1" label="customize_4_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'NoCaching'
    .Customize(x => x.NoCaching())
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## RelatesToShape

Please check our dedicated [article](../../../../client-api/session/querying/how-to-query-a-spatial-index.mdx).



## SetAllowMultipleIndexEntriesForSameDocumentToResultTransformer

If set to true, multiple index entries will be send from the same document (assuming the index project them) to the result transformer function. Otherwise, those entries will be consolidate an the transformer will be called just once for each document in the result set.

<TabItem value="customize_5_0" label="customize_5_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization
	SetAllowMultipleIndexEntriesForSameDocumentToResultTransformer(bool val);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **val** | bool | Indicates if multiple index entries can be send from the same document to result transformer. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_5_1" label="customize_5_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'NoTracking'
    .Customize(x => x.NoTracking())
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## SetHighlighterTags

Please check our dedicated [article](../../../../client-api/session/querying/how-to-use-highlighting.mdx).



## ShowTimings

By default, detailed timings (duration of Lucene search, loading documents, transforming results) in queries are turned off, this is due to small overhead that calculation of such timings produces.

<TabItem value="customize_6_0" label="customize_6_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization ShowTimings();
`}
</CodeBlock>
</TabItem>

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

Returned timings:

- Query parsing
- Lucene search
- Loading documents
- Transforming results

### Example

<TabItem value="customize_6_1" label="customize_6_1">
<CodeBlock language="csharp">
{`List<string> results = session
    .Query<Employees_ByFullName.IndexEntry, Employees_ByFullName>()
     // Call 'Customize'
     // Pass the requested projection behavior to the 'Projection' method
    .Customize(x => x.Projection(ProjectionBehavior.FromDocumentOrThrow))
     // Select the fields that will be returned by the projection
    .Select(x => x.FullName)
    .ToList();
`}
</CodeBlock>
</TabItem>



## SortByDistance

Please check our dedicated [article](../../../../client-api/session/querying/how-to-query-a-spatial-index.mdx).

## Spatial

Please check our dedicated [article](../../../../client-api/session/querying/how-to-query-a-spatial-index.mdx).



## TransformResults

`TransformResults` is a **client-side** function that allows any transformations on query results.

<TabItem value="customize_7_0" label="customize_7_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization TransformResults(
	Func<IndexQuery, IEnumerable<object>, IEnumerable<object>> resultsTransformer);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **resultsTransformer** | Func&lt;IndexQuery, IEnumerable&lt;object&gt;, IEnumerable&lt;object&gt;&gt; | Transformation function. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_7_1" label="customize_7_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
    // Call 'Customize' with 'RandomOrdering'
    .Customize(x => x.RandomOrdering())
    .ToList();
`}
</CodeBlock>
</TabItem>



## WaitForNonStaleResults

<Admonition type="note" title="">
This methods should be used only for testing purposes and are considered **EXPERT ONLY**
</Admonition>

Queries can be 'instructed' to wait for non-stale results for specified amount of time using `WaitForNonStaleResults` method. It is not advised to use this method, because on live databases indexes might never become unstale.

<TabItem value="customize_8_0" label="customize_8_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization WaitForNonStaleResults(TimeSpan? waitTimeout);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **waitTimeout** | TimeSpan | Time to wait for index to return non-stale results. Default: 15 seconds. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_8_1" label="customize_8_1">
<CodeBlock language="csharp">
{`List<Employee> results = session
    .Query<Employee>()
     // Call 'Customize' with 'WaitForNonStaleResults'
    .Customize(x => x.WaitForNonStaleResults(TimeSpan.FromSeconds(10)))
    .Where(x => x.FirstName == "Robert")
    .ToList();
`}
</CodeBlock>
</TabItem>



## WaitForNonStaleResultsAsOf

Queries can be 'instructed' to wait for non-stale results as of cutoff DateTime or Etag for specified amount of time using `WaitForNonStaleResultsAsOf` method.

<TabItem value="customize_9_0" label="customize_9_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization WaitForNonStaleResultsAsOf(DateTime cutOff);

IDocumentQueryCustomization WaitForNonStaleResultsAsOf(
	DateTime cutOff,
	TimeSpan waitTimeout);

IDocumentQueryCustomization WaitForNonStaleResultsAsOf(Etag cutOffEtag);

IDocumentQueryCustomization WaitForNonStaleResultsAsOf(
	Etag cutOffEtag,
	TimeSpan waitTimeout);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **cutOff** | DateTime | Minimum modified date of last indexed document. If last indexed document modified date is greater than this value the results are considered non-stale. |
| **cutOffEtag** | Etag | Minimum Etag of last indexed document. If last indexed document etag is greater than this value the results are considered non-stale. |
| **waitTimeout** | TimeSpan | Time to wait for index to return non-stale results. Default: 15 seconds. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |



## WaitForNonStaleResultsAsOfLastWrite

Queries can be 'instructed' to wait for non-stale results as of last write made by any session belonging to the current DocumentStore using `WaitForNonStaleResultsAsOfLastWrite` method.

This method internally uses `WaitForNonStaleResultsAsOf` and passes last written Etag, which DocumentStore tracks, to `cutOffEtag` parameter.

<TabItem value="customize_10_0" label="customize_10_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization WaitForNonStaleResultsAsOfLastWrite();

IDocumentQueryCustomization WaitForNonStaleResultsAsOfLastWrite(TimeSpan waitTimeout);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **waitTimeout** | TimeSpan | Time to wait for index to return non-stale results. Default: 15 seconds. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_10_1" label="customize_10_1">
<CodeBlock language="csharp">
{`List<Employee> results = session.Query<Employee>()
	.Customize(x => x.WaitForNonStaleResultsAsOfLastWrite())
	.Where(x => x.FirstName == "Robert")
	.ToList();
`}
</CodeBlock>
</TabItem>



## WaitForNonStaleResultsAsOfNow

`WaitForNonStaleResultsAsOfNow` internally uses `WaitForNonStaleResultsAsOf` and passes `DateTime.Now` to `cutOff` parameter.

<TabItem value="customize_11_0" label="customize_11_0">
<CodeBlock language="csharp">
{`IDocumentQueryCustomization WaitForNonStaleResultsAsOfNow();

IDocumentQueryCustomization WaitForNonStaleResultsAsOfNow(TimeSpan waitTimeout);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **waitTimeout** | TimeSpan | Time to wait for index to return non-stale results. Default: 15 seconds. |

| Return Value | |
| ------------- | ----- |
| IDocumentQueryCustomization | Returns self for easier method chaining. |

### Example

<TabItem value="customize_11_1" label="customize_11_1">
<CodeBlock language="csharp">
{`List<Employee> results = session.Query<Employee>()
	.Customize(x => x.WaitForNonStaleResultsAsOfNow())
	.Where(x => x.FirstName == "Robert")
	.ToList();
`}
</CodeBlock>
</TabItem>



## WithinRadiusOf

Please check our dedicated [article](../../../../client-api/session/querying/how-to-query-a-spatial-index.mdx).



