import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Use the `CompactDatabaseOperation` compaction operation to **removes empty gaps on disk** 
  that still occupy space after deletes.  
  You can choose whether to compact _documents_ and/or _selected indexes_.  

* **During compaction the database will be offline**.  
  The operation is a executed asynchronously as a background operation and can be waited for 
  using `wait_for_completion`.  

* The operation will **compact the database on one node**.  
  To compact all database-group nodes, the command must be sent to each node separately.  

* **Target node**:  
  By default, the operation will be executed on the server node that is defined by the 
  [client configuration](../../../../client-api/configuration/load-balance/overview.mdx#client-logic-for-choosing-a-node).  

* **Target database**:  
  The database to compact is specified in `CompactSettings` (see examples below).  
  An exception is thrown if the specified database doesn't exist on the server node.  

* In this page:  
  * [Examples](../../../../client-api/operations/server-wide/compact-database.mdx#examples):  
      * [Compact documents](../../../../client-api/operations/server-wide/compact-database.mdx#examples)  
      * [Compact specific indexes](../../../../client-api/operations/server-wide/compact-database.mdx#compact-specific-indexes)  
      * [Compact all indexes](../../../../client-api/operations/server-wide/compact-database.mdx#compact-all-indexes)  
  * [Compaction triggers compression](../../../../client-api/operations/server-wide/compact-database.mdx#compaction-triggers-compression)  
  * [Compact from Studio](../../../../client-api/operations/server-wide/compact-database.mdx#compact-from-studio)  

</Admonition>
## Examples

#### Compact documents:

The following example will compact only **documents** for the specified database.  

<TabItem value="compact_0" label="compact_0">
<CodeBlock language="python">
{`# Define the compact settings
settings = CompactSettings(
    # Database to compact
    "Northwind",
    # Set 'documents' to True to compact all documents in database
    # Indexes are not set and will not be compacted
    documents=True,
)

# Define the compact operation, pass the settings
compact_op = CompactDatabaseOperation(settings)

# Execute compaction by passing the operation to maintenance.server.send
operation = store.maintenance.server.send_async(compact_op)

# Wait for operation to complete, during compaction the database is offline
operation.wait_for_completion()
`}
</CodeBlock>
</TabItem>
#### Compact specific indexes:

The following example will compact only specific indexes.

<TabItem value="compact_1" label="compact_1">
<CodeBlock language="python">
{`# Define the compact settings
settings = CompactSettings(
    # Database to compact
    database_name="Northwind",
    # Setting 'documents' to False will compact only the specified indexes
    documents=False,
    # Specify which indexes to compact
    indexes=["Orders/Totals", "Orders/ByCompany"],
    # Optimize indexes is Lucene's feature to gain disk space and efficiency
    # Set whether to skip this optimization when compacting the indexes
    skip_optimize_indexes=False,
)
# Define the compact operation, pass the settings
compact_op = CompactDatabaseOperation(settings)

# Execute compaction by passing the operation to maintenance.server.send
operation = store.maintenance.server.send_async(compact_op)
# Wait for operation to complete
operation.wait_for_completion()
`}
</CodeBlock>
</TabItem>
#### Compact all indexes:

The following example will compact all indexes and documents.  

<TabItem value="compact_2" label="compact_2">
<CodeBlock language="python">
{`#  Get all indexes names in the database using the 'GetIndexNamesOperation' operation
#  Use 'ForDatabase' if the target database is different from the default database defined on the store
all_indexes_names = store.maintenance.for_database("Northwind").send(GetIndexNamesOperation(0, int_max))

# Define the compact settings
settings = CompactSettings(
    database_name="Northwind",  # Database to compact
    documents=True,  # Compact all documents
    indexes=all_indexes_names,  # All indexes will be compacted
    skip_optimize_indexes=True,  # Skip Lucene's indexes optimization
)

# Define the compact operation, pass the settings
compact_op = CompactDatabaseOperation(settings)

# Execute compaction by passing the operation to maintenance.server.send
operation = store.maintenance.server.send(compact_op)
# Wait for operation to complete
operation.wait_for_completion()
`}
</CodeBlock>
</TabItem>



## Compaction triggers compression

* When document [compression](../../../../server/storage/documents-compression.mdx) is turned on, compression is applied to the documents when:
  * **New** documents that are created and saved.  
  * **Existing** documents that are modified and saved.  

* You can use the [compaction](../../../../client-api/operations/server-wide/compact-database.mdx) operation 
  to **compress existing documents without having to modify and save** them.  
  Executing compaction triggers compression on ALL existing documents for the collections that are configured for compression.

* Learn more about Compression -vs- Compaction [here](../../../../server/storage/documents-compression.mdx#compression--vs--compaction).



## Compact from Studio

* Compaction can be triggered from the [Storage Report](../../../../studio/database/stats/storage-report.mdx) view in the Studio.  
  The operation will compact the database only on the node being viewed (node info is in the Studio footer).
 
* To compact the database on another node,  
  simply trigger compaction from the Storage Report view in a browser tab opened for that other node.






