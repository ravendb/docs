import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* You can use compare-exchange values in **dynamic queries** in two ways:  
  * **Project** compare-exchange values into the query results.    
  * **Filter** documents based on compare-exchange values.  
  
* Dynamic queries are queries that do not rely on a predefined static index.  
  When you run a dynamic query with a filtering condition, RavenDB automatically creates an auto-index to serve it.  
  Learn more about dynamic queries in the [Query overview](../client-api/session/querying/how-to-query).

* In this article: 
  * [Projecting compare-exchange values in query results](../compare-exchange/cmpxchg-in-dynamic-queries#projecting-compare-exchange-values-in-query-results)  
  * [Filtering by compare-exchange value](../compare-exchange/cmpxchg-in-dynamic-queries#filtering-by-compare-exchange-value)  
    * [Example 1 - Filtering when the compare-exchange value is a string](../compare-exchange/cmpxchg-in-dynamic-queries#example-1---filtering-when-the-compare-exchange-value-is-a-string)  
    * [Example 2 - Filtering when the compare-exchange value is an object](../compare-exchange/cmpxchg-in-dynamic-queries#example-2---filtering-when-the-compare-exchange-value-is-an-object)  
  * [Syntax](../compare-exchange/cmpxchg-in-dynamic-queries#syntax)  

</Admonition>

---

## Projecting compare-exchange values in query results

* You can project values from compare-exchange items alongside fields from the queried documents.

* The following example is based on the sample data described in: [Create sample compare-exchange items](../compare-exchange/indexing-cmpxchg-values#create-sample-compare-exchange-items).   
  In this example, we want to retrieve the current number of guests in each room.  
  We query all _HotelRoom_ documents and project:
  * the number of guests (from the compare-exchange item's value), and  
  * the room number (from the document field).  
  
* No auto-index is created in this case, since the query doesn’t apply any filters.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
```js
// The session does not need to be opened in cluster-wide mode
const session = documentStore.openSession();

// Define the projection using QueryData:
const queryData = QueryData.customFunction("room", `{
  // Project from compare-exchange: call cmpxchg with RoomNumber
  CurrentNumberOfGuests: cmpxchg(room.RoomNumber).CurrentNumberOfGuests,
  
  // Project from document field
  RoomNumber: room.RoomNumber
}`);

const numberOfGuestsPerRoom = await session
    .query({ collection: "HotelRooms" })
     // Project content:
    .selectFields(queryData)
    .all();
```
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
```js
const session = documentStore.openSession();

const numberOfGuestsPerRoom = await session.advanced
    .rawQuery(`
        from 'HotelRooms' as x 
        select {
            CurrentNumberOfGuests : cmpxchg(x.RoomNumber).CurrentNumberOfGuests,
            RoomNumber : x.RoomNumber
        }
    `)
    .all();
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql
from "HotelRooms" as x 
select { 
    CurrentNumberOfGuests : cmpxchg(x.RoomNumber).CurrentNumberOfGuests,
    RoomNumber : x.RoomNumber 
}
```
</TabItem>
</Tabs>

---

## Filtering by compare-exchange value

#### Example 1 - Filtering when the compare-exchange value is a string

* You can filter documents based on a compare-exchange value.  
  For example, to find a user with a blocked email address,  
  you can filter by the compare-exchange value that stores the blocked email.

* **Limitation**:  
  When filtering with `cmpxchg` inside the `where` predicate (as shown in this example),  
  the compare-exchange value must be a _string_.  
  If your compare-exchange value is of another type, you can still filter the results - 
  see the [next example](../compare-exchange/cmpxchg-in-dynamic-queries#example-2---filtering-when-the-compare-exchange-value-is-an-object).
  
* Since this query uses filtering, RavenDB will automatically create an auto-index to serve it.  
  In this case, the auto-index `Auto/Users/ByEmail` will be created.  
  
<Tabs groupId='languageSyntax'>
<TabItem value="RawQuery" label="RawQuery">
```js
// First, let's create a compare-exchange item with a blocked email address for this example:
const putResult = await documentStore.operations.send(
    new PutCompareExchangeValueOperation("blocked-address", "someUser@Company.com", 0)
);

// Query the 'Users' collection
// Find a user with an email address that matches the blocked address:
// (The session does not need to be opened in cluster-wide mode)
const session = documentStore.openSession();

const blockedUser = await session.advanced
    .rawQuery(`
        from 'Users' 
        where Email == cmpxchg('blocked-address')
    `)
    .firstOrNull();
    
// The results will include the user document whose email address is "someUser@company.com"
// (assuming such a user exists in your data).    
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql    
from "Users" 
where Email == cmpxchg("blocked-address")
limit 0, 1
```
</TabItem>
<TabItem value="User_class" label="User_class">
```js
class User {
    constructor(id, name, email) {
        this.Id = id;
        this.Name = name;
        this.Email = email;
    }
}
```
</TabItem>
</Tabs>

#### Example 2 - Filtering when the compare-exchange value is an object

* The following example shows how to filter documents based on a compare-exchange value that is an _object_.  
  We query for users whose email ends with one of the domains stored in the object held by the compare-exchange item.

* Retrieve the compare-exchange value outside the query, then use its content to build the filter logic.  

* Since this query uses filtering, RavenDB will automatically create an auto-index to serve it.  
  In this case, the auto-index `Auto/Users/ByEmail` will be created.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
```js
// First, let's create a compare-exchange item with a value that is an object.
// The object contains multiple blocked email domains for this example.
const blockedDomainsValue = {
    Domains: ["suspicious-company-1.com", "suspicious-company-2.org"]
};
const putResult = await documentStore.operations.send(
    new PutCompareExchangeValueOperation("blocked-domains", blockedDomainsValue, 0)
);
    
// Retrieve the compare-exchange value before running the query
const blockedDomainsResult = await documentStore.operations.send(
    new GetCompareExchangeValueOperation("blocked-domains")
);
const blockedDomains = blockedDomainsResult.value;
            
// Query the 'Users' collection
// Find users whose email address ends with one of the blocked domains.
// (The session does not need to be opened in cluster-wide mode)
const session = documentStore.openSession();

const blockedUsers = await session
    .query({ collection: "Users" })
    .whereEndsWith("Email", blockedDomains.Domains[0])
    .orElse()
    .whereEndsWith("Email", blockedDomains.Domains[1])
    .all();

// The results will include users whose email address domain ends with
// one of the values stored in the compare-exchange item,
// assuming such users exist in your data.
```
</TabItem>
<TabItem value="RawQuery" label="RawQuery">
```js
const blockedDomainsValue = {
    Domains: ["suspicious-company-1.com", "suspicious-company-2.org"]
};

const putResult = await documentStore.operations.send(
    new PutCompareExchangeValueOperation("blocked-domains", blockedDomainsValue, 0)
);
    
const blockedDomainsResult = await documentStore.operations.send(
    new GetCompareExchangeValueOperation("blocked-domains")
);
const blockedDomains = blockedDomainsResult.value;  
    
const session = documentStore.openSession();

const blockedUsers = await session.advanced
    .rawQuery(`
        from 'Users' 
        where endsWith(Email, 'suspicious-company-1.com') 
        or endsWith(Email, 'suspicious-company-2.org')
    `)
    .all();
```
</TabItem>
<TabItem value="RQL" label="RQL">
```sql    
from "Users" 
where endsWith(Email, "suspicious-company-1.com") 
or 
endsWith(Email, "suspicious-company-2.org")
```
</TabItem>
<TabItem value="User_class" label="User_class">
```js
class User {
    constructor(id, name, email) {
        this.Id = id;
        this.Name = name;
        this.Email = email;
    }
}
```
</TabItem>
</Tabs>

---

## Syntax

### `cmpxchg()`  
This function can be used to filter a query  
or to project fields from a compare-exchange value into the query results.

<TabItem value="" label="">
```js
// Get a compare-exchange value by key.
// Used inside 'where', 'selectFields', or rawQuery.
cmpxchg(key)
```
</TabItem>
